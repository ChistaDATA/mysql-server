--source include/have_router.inc
--source include/have_group_replication_plugin.inc

--source ../include/predefined_setup/configure_router_mrs_root_with_gr_single.inc
--source ../include/schema/basic_schema.sql


# The test uses HOST to have only paths in HREF fields.
--let $mrs_add_service_path="/svc"
--let $mrs_add_host_name=""
--source ../include/mrs/add_service.inc

--let $mrs_add_schema=basic_schema
--let $mrs_add_schema_path=/basic
--source ../include/mrs/db_schema/add.inc

--let $mrs_add_db_object=table1
--let $mrs_add_db_object_path=/t1
--let $mrs_add_db_object_options='{"logging":{"exceptions":true, "request":{"headers":true, "body":true}, "response":{"headers":true, "body":true}}}'
--source ../include/mrs/db_object/add.inc

--let $mrs_add_db_object=table2
--let $mrs_add_db_object_path=/t2
--let $mrs_add_db_object_options='{"logging":{"exceptions":true, "request":{"headers":true, "body":true}, "response":{"headers":true, "body":true}}}'
--source ../include/mrs/db_object/add.inc


--let $mrs_host_and_port=127.0.0.1:$extra_http_port
--let MRS_CLIENT_ARGS=$MRS_CLIENT --url https://$mrs_host_and_port

#--exec $MRS_CLIENT_ARGS --path /svc/basic/t1 --wait-until-found=60  --request-type post --payload '{"id":1010}'

--exec $MRS_CLIENT_ARGS --path /svc/basic/t1 --wait-until-found=60
--exec $MRS_CLIENT_ARGS --path /svc/basic/t1/1
--exec $MRS_CLIENT_ARGS --path /svc/basic/t1/20
--exec $MRS_CLIENT_ARGS --path /svc/basic/t1/2 --expected-status 404
exec $MRS_CLIENT_ARGS --path /svc/basic/t1/20
  --write-to-file $MYSQL_TMP_DIR/gtid.inc
  --write-format mtr
  --request-type delete
  --display RESULT
  --json-pointer /_metadata/gtid;

--source $MYSQL_TMP_DIR/gtid.inc


# Hide GTIDS by setting: BODY,RESULT
exec $MRS_CLIENT_ARGS
  --path /svc/basic/t1?q={\"id\":20,\"\$asof\":\"$mrs_result\"}
  --display BODY,RESULT
  --json-pointer /count;

--exec $MRS_CLIENT_ARGS --path /svc/basic/t2
--exec $MRS_CLIENT_ARGS --path /svc/basic/t2/1
--exec $MRS_CLIENT_ARGS --path /svc/basic/t2/200 --expected-status 404
exec $MRS_CLIENT_ARGS --path /svc/basic/t2
  --write-to-file $MYSQL_TMP_DIR/gtid.inc
  --write-format mtr
  --request-type post
  --json-pointer /_metadata/gtid
  --display RESULT
  --payload '{"id":3000, "name":"PUT item", "date":"1920-12-1"}';

--source $MYSQL_TMP_DIR/gtid.inc
--exec $MRS_CLIENT_ARGS --path /svc/basic/t2?q={\"id\":3000,\"\$asof\":\"$mrs_result\"} --display BODY,RESULT
--exec $MRS_CLIENT_ARGS --expected-status 400 --path /svc/basic/t2?q={\"id\":3001,\"\$asof\":\"3E11FA47-71CA-11E1-9E33-C80AA9429562:1-5\"} --display BODY,RESULT
exec $MRS_CLIENT_ARGS 
  --expected-status 400
  --request-type delete
  --path /svc/basic/t2?q={\"id\":3001,\"\$asof\":\"3E11FA47-71CA-11E1-9E33-C80AA9429561:1-5\"}
  --display BODY,RESULT;

# Cleanup
DROP SCHEMA basic_schema;
--remove_file $MYSQL_TMP_DIR/gtid.inc
--source ../include/innodb_cluster/cleanup.inc
--source ../include/mrs/cleanup.inc
--source include/rpl_sync.inc
--source include/group_replication_end.inc
