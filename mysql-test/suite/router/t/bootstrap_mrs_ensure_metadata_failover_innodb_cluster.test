--source include/have_router_bootstrap.inc
--source include/have_group_replication_plugin.inc

--source ../include/predefined_setup/configure_innodb_cluster_gr.inc

--echo Create an user for bootstrap
CREATE USER 'admin'@'%' IDENTIFIED BY 'admin_pass';
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;

################################################################################
--echo I. Bootstrap the MRS with --mrs-ensure-metadata-schema parameter and no --mrs
--echo The expectation is that only schema gets created.
--echo Use the Primary node port, the Router should create the schema successfully.
exec $MYSQLROUTER_BOOTSTRAP
   --conf-set-option=DEFAULT.plugin_folder=$ROUTER_PLUGIN_DIRECTORY
   -B admin:admin_pass@127.0.0.1:$MASTER_MYPORT
   --mrs-ensure-metadata-schema --logger.level=debug;

--echo Check that the schema was created
SELECT * FROM mysql_rest_service_metadata.schema_version;

################################################################################
--echo II. Bootstrap the MRS with --mrs-ensure-metadata-schema parameter and no --mrs
--echo The expectation is that only schema gets created.
--echo Use the Secondary node port, the Router should failover to the primary and
--echo create the schema successfully.
DROP DATABASE mysql_rest_service_metadata;

exec $MYSQLROUTER_BOOTSTRAP
   --conf-set-option=DEFAULT.plugin_folder=$ROUTER_PLUGIN_DIRECTORY
   -B admin:admin_pass@127.0.0.1:$SERVER_MYPORT_2
   --mrs-ensure-metadata-schema --logger.level=debug;

--echo Check that the schema was created
SELECT * FROM mysql_rest_service_metadata.schema_version;

################################################################################
--echo Cleanup

--let $cleanup_arg_mrs_skip_service_disable=1
--source ../include/mrs/cleanup.inc
--source ../include/innodb_cluster/cleanup.inc

REVOKE ALL PRIVILEGES, GRANT OPTION FROM 'admin';
DROP USER 'admin';

--source include/rpl/sync.inc
--source include/group_replication_end.inc
